/* exported App */
class App {
  /**
   * @param {App.Settings} [settings] –ù–∞—á–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.
   */
  constructor(settings) {
    this._settings = settings;
  }

  /**
   * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç GET-–∑–∞–ø—Ä–æ—Å—ã.
   * @param {GoogleAppsScript.Events.DoGet} e –û–±—ä–µ–∫—Ç —Å–æ–±—ã—Ç–∏—è.
   * @returns {GoogleAppsScript.Content.TextOutput} JSON-–æ—Ç–≤–µ—Ç.
   */
  doGet(e) {
    const out = { error: undefined, data: undefined, action: undefined };

    return ContentService.createTextOutput(JSON.stringify(out)).setMimeType(ContentService.MimeType.JSON);
  }

  /**
   * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç POST-–∑–∞–ø—Ä–æ—Å—ã.
   * @param {GoogleAppsScript.Events.DoPost} e –û–±—ä–µ–∫—Ç —Å–æ–±—ã—Ç–∏—è.
   * @returns {GoogleAppsScript.Content.TextOutput} JSON-–æ—Ç–≤–µ—Ç.
   */
  doPost(e) {
    const out = { error: undefined, data: undefined, action: undefined };
    const contents = JSON.parse(e.postData.contents);

    if (
      contents.access_token &&
      contents.access_token === this.settings.ADMIN_ACCESS_TOKEN &&
      contents.action === 'get_app_current_id'
    ) {
      out.data = {
        APP_CURRENT_ID: this.settings.APP_CURRENT_ID,
      };
      out.action = contents.action;
      return ContentService.createTextOutput(JSON.stringify(out)).setMimeType(ContentService.MimeType.JSON);
    }
    return ContentService.createTextOutput(
      JSON.stringify({ result: contents, res: contents.access_token }),
    ).setMimeType(ContentService.MimeType.JSON);
  }

  /**
   * –¢–µ–∫—É—â–∞—è –∫–Ω–∏–≥–∞ (—Ç–∞–±–ª–∏—Ü–∞).
   * @type {GoogleAppsScript.Spreadsheet.Spreadsheet}
   */
  get currentBook() {
    if (!this._currentBook) this._currentBook = SpreadsheetApp.openById(this.settings.APP_CURRENT_ID);
    return this._currentBook;
  }

  /**
   * @param {GoogleAppsScript.Spreadsheet.Spreadsheet} book
   */
  set currentBook(book) {
    this._currentBook = book;
  }

  /**
   * –†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∞—è –ø–∞–ø–∫–∞.
   * @type {GoogleAppsScript.Drive.Folder}
   */
  get folder() {
    if (!this._folder) this._folder = DriveApp.getFolderById(this.settings.APP_FOLDER_ID);
    return this._folder;
  }

  /**
   * @returns {App.Settings}
   */
  get settings() {
    if (!this._settings) {
      this._settings = PropertiesService.getScriptProperties().getProperties();
      this._settings.APP_LIST_OF_EXEPTIONS_SHEETS = JSON.parse(this._settings.APP_LIST_OF_EXEPTIONS_SHEETS);
    }
    return this._settings;
  }

  /**
   * @param {App.Settings} settings
   */
  set settings(settings) {
    const data = JSON.parse(JSON.stringify(settings));
    if (this._settings && this._settings.APP_CURRENT_ID !== data.APP_CURRENT_ID) this._book = undefined;
    data.APP_LIST_OF_EXEPTIONS_SHEETS = JSON.stringify(data.APP_LIST_OF_EXEPTIONS_SHEETS || '[]');
    PropertiesService.getScriptProperties().setProperties(data, false);
    this._settings = undefined;
  }

  /**
   * –ü–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–Ω–∏–≥–µ –∏–∑ Sheets API.
   * @type {GoogleAppsScript.Sheets.Schema.Spreadsheet}
   */
  get book() {
    if (!this._book) this.recallBook();
    return this._book;
  }

  /**
   * –û–±–Ω–æ–≤–ª—è–µ—Ç –∫–µ—à –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–Ω–∏–≥–µ (`this._book`).
   */
  recallBook() {
    this._book = Sheets.Spreadsheets.get(this.currentBook.getId(), {
      includeGridData: false,
      fields: 'spreadsheetId,sheets(properties(sheetId,index,title),protectedRanges(range,protectedRangeId))',
    });
  }

  /**
   * –°–æ—Ä—Ç–∏—Ä—É–µ—Ç –¢–∞–±–ª–∏—Ü—É –∑–∞–¥–∞–Ω–Ω—ã–º –æ–±—Ä–∞–∑–æ–º.
   * –°–Ω–∞—á–∞–ª–∞ –∏–¥—É—Ç –ª–∏—Å—Ç—ã –∏–∑ —Å–ø–∏—Å–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π `APP_LIST_OF_EXEPTIONS_SHEETS` –≤ —Ç–æ–º –ø–æ—Ä—è–¥–∫–µ, –≤ –∫–æ—Ç–æ—Ä–æ–º –æ–Ω–∏ —É–∫–∞–∑–∞–Ω—ã –≤ —Å–ø–∏—Å–∫–µ.
   * –ó–∞—Ç–µ–º –∏–¥—É—Ç –∑–∞—â–∏—â–µ–Ω–Ω—ã–µ –ª–∏—Å—Ç—ã.
   * –í –∫–æ–Ω—Ü–µ –∏–¥—É—Ç –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ª–∏—Å—Ç—ã.
   *
   * @returns {void} –ù–∏—á–µ–≥–æ –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç. –û–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ—Ä—è–¥–æ–∫ –ª–∏—Å—Ç–æ–≤ –≤ —Ç–µ–∫—É—â–µ–π –∫–Ω–∏–≥–µ.
   */
  orderSheetsByProtections() {
    const exeptionSheetNames = this.settings.APP_LIST_OF_EXEPTIONS_SHEETS;
    const sorted = JSON.parse(JSON.stringify(this.book.sheets)).sort((a, b) => {
      const excludesA = exeptionSheetNames.indexOf(a.properties.title);
      const excludesB = exeptionSheetNames.indexOf(b.properties.title);
      if (excludesA > -1 && excludesB > -1) return excludesA - excludesB;
      if (excludesA > -1) return -1;
      if (excludesB > -1) return 1;
      const protectedA = a.protectedRanges?.some((r) => Object.keys(r.range).length === 1) ?? false;
      const protectedB = b.protectedRanges?.some((r) => Object.keys(r.range).length === 1) ?? false;
      return protectedA - protectedB;
    });
    const requests = [];
    requests.push(
      ...sorted.map((sheet, index) => {
        const updatePropertiesRequest = Sheets.newUpdateSheetPropertiesRequest();
        updatePropertiesRequest.fields = 'index';
        updatePropertiesRequest.properties = {
          index,
          sheetId: sheet.properties.sheetId,
        };
        const request = Sheets.newRequest();
        request.updateSheetProperties = updatePropertiesRequest;
        return request;
      }),
    );
    const resource = Sheets.newBatchUpdateSpreadsheetRequest();
    resource.requests = requests;
    resource.responseIncludeGridData = false;
    Sheets.Spreadsheets.batchUpdate(resource, this.settings.APP_CURRENT_ID);
    this.book.sheets = sorted;
  }

  /**
   * –î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–π –ª–∏—Å—Ç –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞
   */
  addNewBlankUserSheet() {
    if (!this.book.sheets.some((sheet) => sheet.properties.title === '–ù–æ–≤—ã–π –ª–∏—Å—Ç –¥–ª—è –≤–∞—à–µ–≥–æ –ø—Ä–∏–º–µ—Ä–∞')) {
      const addSheetRequest = Sheets.newAddSheetRequest();
      addSheetRequest.properties = {
        index: 1,
        title: '–ù–æ–≤—ã–π –ª–∏—Å—Ç –¥–ª—è –≤–∞—à–µ–≥–æ –ø—Ä–∏–º–µ—Ä–∞',
      };
      const request = Sheets.newRequest();
      request.addSheet = addSheetRequest;
      const resource = Sheets.newBatchUpdateSpreadsheetRequest();
      resource.requests = [request];
      resource.includeSpreadsheetInResponse = true;
      resource.responseIncludeGridData = false;
      const reply = Sheets.Spreadsheets.batchUpdate(resource, this.settings.APP_CURRENT_ID).replies.find(
        (reply) => reply.addSheet,
      ).addSheet;
      this._book.sheets.splice(1, 0, {
        properties: reply.properties,
      });
      this._book.sheets.forEach((sheet, i) => (sheet.properties.index = i));
    }
  }

  /**
   * –û–±–Ω–æ–≤–ª—è–µ—Ç —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
   */
  generateTOC() {
    const excludeSheetNames = this.settings.APP_LIST_OF_EXEPTIONS_SHEETS;

    const richTextValues = this.book.sheets
      .filter((item) => excludeSheetNames.indexOf(item.properties.title) === -1)
      .map((item) => [
        SpreadsheetApp.newRichTextValue()
          .setText(
            `${item.protectedRanges?.some((r) => Object.keys(r.range).length === 1) ?? false ? 'üîè ' : ''}${
              item.properties.title
            }`,
          )
          .setLinkUrl(`#gid=${item.properties.sheetId}`)
          .build(),
      ]);
    const firstPage = this.currentBook.getSheetByName('–û –¢–∞–±–ª–∏—Ü–µ');
    const pos = firstPage.createTextFinder('–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ').matchCase(true).matchFormulaText(false).findNext();
    if (pos) {
      const range = firstPage.getRange(pos.getRow() + 1, pos.getColumn(), firstPage.getLastRow()).clearContent();
      range.offset(0, 0, richTextValues.length, richTextValues[0].length).setRichTextValues(richTextValues);
    }
  }

  /**
   * –£–¥–∞–ª—è–µ—Ç –≤—Å–µ –ª–∏—Å—Ç—ã, –∫—Ä–æ–º–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–π.
   * @param {{excludes: string[]}} param0
   * @param {string[]} param0.excludes –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ª–∏—Å—Ç–æ–≤-–∏—Å–∫–ª—é—á–µ–Ω–∏–π.
   */
  cleanBook({ excludes }) {
    const excludesE = excludes || [];
    const listExceptions = [...this.settings.APP_LIST_OF_EXEPTIONS_SHEETS, ...excludesE];
    const requests = this.book.sheets
      .filter((sheet) => !listExceptions.includes(sheet.properties.title))
      .map((sheet) => {
        const deleteSheetRequest = Sheets.newDeleteSheetRequest();
        deleteSheetRequest.sheetId = sheet.properties.sheetId;
        const request = Sheets.newRequest();
        request.deleteSheet = deleteSheetRequest;
        return request;
      });
    if (requests.length) {
      Sheets.Spreadsheets.batchUpdate({ requests }, this.book.spreadsheetId);
      this._book = undefined;
    }
  }

  /**
   * –û—Ç–≤—è–∑—ã–≤–∞–µ—Ç –∏ —É–¥–∞–ª—è–µ—Ç –≤—Å–µ —Ñ–æ—Ä–º—ã, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å —Ç–µ–∫—É—â–µ–π –∫–Ω–∏–≥–æ–π.
   */
  unlinkForms() {
    this.currentBook.getSheets().forEach((sheet) => {
      const formUrl = sheet.getFormUrl();
      if (formUrl) {
        const form = FormApp.openByUrl(formUrl);
        form.removeDestination();
        const id = form.getId();
        DriveApp.getFileById(id).setTrashed(true);
        console.info(`Unlinked form '${id}' from sheet: ${sheet.getName()}`);
      }
    });
  }

  /**
   * –î–æ–±–∞–≤–ª—è–µ—Ç —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —à—Ç–∞–º–ø –≤ "–û –¢–∞–±–ª–∏—Ü–µ".
   * @param {{num: number, prevUrl: string, prevTitle: string}} stamp
   * @param {number} stamp.num –ù–æ–≤—ã–π –Ω–æ–º–µ—Ä —Ç–∞–±–ª–∏—Ü—ã.
   * @param {string} stamp.prevUrl URL –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Ç–∞–±–ª–∏—Ü—ã.
   * @param {string} stamp.prevTitle –ò–º—è –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Ç–∞–±–ª–∏—Ü—ã.
   */
  updateStamp({ num, prevUrl, prevTitle }) {
    if (this.book.sheets.some((sheet) => sheet.properties.title === '–û –¢–∞–±–ª–∏—Ü–µ'))
      Sheets.Spreadsheets.Values.update(
        { values: [[num], [prevUrl, prevTitle]] },
        this.book.spreadsheetId,
        '–û –¢–∞–±–ª–∏—Ü–µ',
        {
          valueInputOption: 'RAW',
        },
      );
  }

  /**
   * –°–Ω–∏–º–∞–µ—Ç –∑–∞—â–∏—Ç—É —Å–æ –≤—Å–µ—Ö –ª–∏—Å—Ç–æ–≤ –≤ –∫–Ω–∏–≥–µ.
   */
  releaseSheets() {
    /** @type {GoogleAppsScript.Sheets.Schema.Sheet[]} */
    const sheets = JSON.parse(JSON.stringify(this.book.sheets));
    const requests = [];
    sheets.forEach((sheet) => {
      sheet.protectedRanges?.forEach((protectedRange) => {
        if (protectedRange.protectedRangeId) {
          const deleteProtectedRangeRequest = Sheets.newDeleteProtectedRangeRequest();
          deleteProtectedRangeRequest.protectedRangeId = protectedRange.protectedRangeId;
          const request = Sheets.newRequest();
          request.deleteProtectedRange = deleteProtectedRangeRequest;
          requests.push(request);
        }
      });
    });
    if (requests.length) {
      const resource = Sheets.newBatchUpdateSpreadsheetRequest();
      resource.requests = requests;
      resource.responseIncludeGridData = false;
      Sheets.Spreadsheets.batchUpdate(resource, this.settings.APP_CURRENT_ID);
      this.book.sheets = sheets;
    }
  }

  /**
   * –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Å—ã–ª–∫–∏ –≤ —Ñ—É—Ç–µ—Ä–µ –Ω–∞ –≤—Å–µ—Ö —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –∫–Ω–∏–≥–∞—Ö.
   * –ù–∞—Ö–æ–¥–∏—Ç –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã –≤ –ø–∞–ø–∫–µ `APP_FOLDER_ID`, –∏ –≤ –∫–∞–∂–¥–æ–π –∏–∑ –Ω–∏—Ö –Ω–∞ –ª–∏—Å—Ç–µ "–û –¢–∞–±–ª–∏—Ü–µ"
   * –≤ —è—á–µ–π–∫–µ D4 –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Å—ã–ª–∫—É –Ω–∞ —á–∞—Ç —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤ –ø–æ Apps Script.
   * –¢–∞–∫–∂–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç –∏ –≤—ã–≤–æ–¥–∏—Ç –≤ –∫–æ–Ω—Å–æ–ª—å –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü.
   *
   * –≠—Ç–æ –∫–∞—Å—Ç–æ–º–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–∞–Ω–∞–ª–∞ "–¢–∞–±–ª–∏—Ü—ã –ì—É–≥–ª"
   */
  updateAllBooks() {
    const SETTINGS = {
      D2: {
        text: '–ö–∞–Ω–∞–ª "–¢–∞–±–ª–∏—Ü—ã –ì—É–≥–ª" t.me/GoogleSheets_ru',
        link: 'https://t.me/+lmannExYEyg5OTZi',
        startOffset: 21,
        rangeA1: 'D2',
      },
      D3: {
        text: '–¢–∞–±–ª–∏—Ü—ã –∏ –°–∫—Ä–∏–ø—Ç—ã –ì—É–≥–ª - —á–∞—Ç t.me/google_sheets_pro',
        link: 'https://t.me/+pLLUBtcXIqY0MGMy',
        startOffset: 29,
        rangeA1: 'D3',
      },
      D4: {
        text: '–ß–∞—Ç –ø–æ Apps Script –¥–ª—è —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤ t.me/googleappsscriptrc',
        link: 'https://t.me/+7HbI3eq42C80MmMy',
        startOffset: 36,
        rangeA1: 'D4',
      },
    };

    const { rangeA1, text, link, startOffset } = SETTINGS.D4;

    const textStyle = SpreadsheetApp.newTextStyle();
    textStyle.setForegroundColor('#434343');
    textStyle.setFontSize(10);
    textStyle.setItalic(true);
    const ts = textStyle.build();
    console.log(this.settings.APP_FOLDER_ID);
    const books = DriveApp.searchFiles(
      `'${this.settings.APP_FOLDER_ID}' in parents and mimeType='application/vnd.google-apps.spreadsheet'`,
    );

    const out = [];

    while (books.hasNext()) {
      const book = SpreadsheetApp.openById(books.next().getId());
      console.log(book.getName());
      const sheet = book.getSheetByName('–û –¢–∞–±–ª–∏—Ü–µ');
      if (sheet) {
        const range = sheet.getRange(rangeA1);
        const item = {};
        item.name = book.getName();
        item.url = book.getUrl();
        item.value = range.getValue();
        item.rtv = range.getRichTextValue().getLinkUrl();
        out.push(item);

        if (item.value !== text || item.rtv !== link) {
          const nrtv = SpreadsheetApp.newRichTextValue();
          nrtv.setText(text);
          nrtv.setTextStyle(ts);
          nrtv.setLinkUrl(startOffset, text.length, link);
          range.setRichTextValue(nrtv.build());
          range.setHorizontalAlignment('right').setVerticalAlignment('middle');
        }
      }
    }

    out
      .sort((a, b) => {
        const aN = Number(a.name.replace(/.*#(\d+).*/, '$1')) || 0;
        const bN = Number(b.name.replace(/.*#(\d+).*/, '$1')) || 0;
        if (aN < bN) return -1;
        if (aN > bN) return 1;
        return 0;
      })
      .forEach((item) => console.log(item));
  }

  /**
   * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∏–º—è –∫–Ω–∏–≥–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ —è—á–µ–µ–∫.
   */
  resetName() {
    let title = '–¢–∞–±–ª–∏—Ü–∞ —á–∞—Ç–∞ ';
    const bookNameRange = this.currentBook.getRangeByName('BOOK_NAME');
    if (bookNameRange) {
      title = bookNameRange.getValue();
    } else {
      const num = this.currentBook.getSheetByName('–û –¢–∞–±–ª–∏—Ü–µ').getRange('A1').getValue();
      title += `#${num}`;
    }
    DriveApp.getFileById(this.settings.APP_CURRENT_ID).setName(title);
  }

  /**
   * –°–æ–∑–¥–∞–µ—Ç –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç —Å–ª–µ–¥—É—é—â—É—é –∫–Ω–∏–≥—É (—Ç–∞–±–ª–∏—Ü—É) —á–∞—Ç–∞.
   */
  createNextBook() {
    const currentBook = DriveApp.getFileById(this.settings.APP_CURRENT_ID);
    const num = Number(this.settings.APP_CURRENT_FILE_NUM) + 1;
    const copy = currentBook.makeCopy(`–¢–∞–±–ª–∏—Ü–∞ —á–∞—Ç–∞ t.me/google_sheets_pro #${num}`, this.folder);
    copy.getEditors().forEach((editor) => copy.removeEditor(editor));
    copy.setSharing(DriveApp.Access.ANYONE, DriveApp.Permission.VIEW);
    if (this.settings.APP_MASTER_EDITOR) {
      copy.addEditor(this.settings.APP_MASTER_EDITOR);
    }
    if (this.settings.APP_EXPERTS_EDITOR) {
      copy.addEditors(this.settings.APP_EXPERTS_EDITOR.split(',').map((email) => email.trim()));
    }
    const settings = { ...this.settings, ...{ APP_CURRENT_FILE_NUM: `${num}`, APP_CURRENT_ID: copy.getId() } };
    const prevUrl = currentBook.getUrl();
    const prevTitle = currentBook.getName();
    this.settings = settings;
    this.updateStamp({ num, prevUrl, prevTitle });
    this.unlinkForms();
    this.cleanBook({ excludes: [] });
    this.addNewBlankUserSheet();
    this.orderSheetsByProtections();
    this.generateTOC();
  }
}
